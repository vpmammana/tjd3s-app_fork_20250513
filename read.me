VPM 20250513

O comando para chamar o pasteur.py está com path errado para o pasteur.py.
                            $command = escapeshellcmd("/var/www/html/venv/bin/python /var/www/html/php/pasteur.py") . ' ' . escapeshellarg($destinationPath);

Tá faltando o diretório raiz do projeto.

Vou usar $projectRoot = dirname(__DIR__);

vou usar 

$pythonPath = $projectRoot . '/venv/bin/python';
$scriptPath = $projectRoot . '/php/pasteur.py';


VPM 20250513

Parece que não criou também imagens no diretório raiz do projeto. Vou criar.

VPM 20250513

Bolsistas desligaram o report de erros, mas ainda temos warnings importantes do ponto de vista de consistência de algoritmo:

[Tue May 13 23:28:56.594698 2025] [php:warn] [pid 198654] [client 127.0.0.1:60088] PHP Warning:  Undefined array key "suburb" in /mnt/disco_ssd_240gb/tjd3s-app_20250512/php/CriarEvidencia.php on line 103, referer: http://localhost/tjd3s-app_fork_20250513/
[Tue May 13 23:28:56.621400 2025] [php:warn] [pid 198654] [client 127.0.0.1:60088] PHP Warning:  file_put_contents(/var/www/html/php/pasteur.lock): Failed to open stream: No such file or directory in /mnt/disco_ssd_240gb/tjd3s-app_20250512/php/CriarEvidencia.php on line 293, referer: http://localhost/tjd3s-app_fork_20250513/
[Tue May 13 23:28:56.621482 2025] [php:notice] [pid 198654] [client 127.0.0.1:60088] destinationPath: ../imagem/input/8510864026823ffe897ba43.19610471.png, referer: http://localhost/tjd3s-app_fork_20250513/
[Tue May 13 23:28:56.621527 2025] [php:warn] [pid 198654] [client 127.0.0.1:60088] PHP Warning:  move_uploaded_file(../imagem/input/8510864026823ffe897ba43.19610471.png): Failed to open stream: No such file or directory in /mnt/disco_ssd_240gb/tjd3s-app_20250512/php/CriarEvidencia.php on line 306, referer: http://localhost/tjd3s-app_fork_20250513/
[Tue May 13 23:28:56.621541 2025] [php:warn] [pid 198654] [client 127.0.0.1:60088] PHP Warning:  move_uploaded_file(): Unable to move &quot;/tmp/phptLh7qC&quot; to &quot;../imagem/input/8510864026823ffe897ba43.19610471.png&quot; in /mnt/disco_ssd_240gb/tjd3s-app_20250512/php/CriarEvidencia.php on line 306, referer: http://localhost/tjd3s-app_fork_20250513/

A questão parece ser a definição de    $lockFile = "/var/www/html/php/pasteur.lock";
Esse diretório php debaixo de html não é criado automaticamente. Substitui por ../locks/pasteur.lock

VPM 20250513

Não esqueça de retornar para error_reporting(0); em todos os arquivos php.

eu mudei para error_reporting(E_ALL); porque estou pegando muitos pequenos erros.


VPM 20250513

Para instalar o environment do Python no local de produção tem que observar a questão de quem é o usuário que faz. Tem que fazer tudo com www-data. Isso não está na "documentação". 

sudo rm -rf /var/www/html/venv
sudo -u www-data python3 -m venv /var/www/html/venv
sudo mkdir -p /var/www/html/venv
sudo chown www-data:www-data /var/www/html/venv
sudo chmod 755 /var/www/html/venv
sudo -u www-data python3 -m venv /var/www/html/venv
sudo -u www-data /var/www/html/venv/bin/python -c "import sys; print(sys.executable)"
sudo -u www-data /var/www/html/venv/bin/pip install --upgrade pip
sudo -u www-data /var/www/html/venv/bin/pip install -r php/requirements.txt

A localização de venv está errada no READ.me provido pelo Marcos.

Não há documentação sobre se precisa de um diretório ./imagem/input

Eu tive que criar.

VPM 20250513

Tem uns file_put_contents perdidos no CriarEvidencia.php

VPM 20250513

O error.log está recebendo essa mensagem em algum momento. Ainda não descobri de onde vem:

[Tue May 13 21:46:12.986866 2025] [php:notice] [pid 90973] [client 127.0.0.1:60338] Executed SQL: \nSELECT \n\tid_tipo_acao, \n\tid_tipo_resultado as id_tipo_resultado_filho, \n\ttr2.id_chave_tipo_resultado as id_tipo_resultado_pai, \n\ttr1.nome_tipo_resultado as nome_tipo_resultado_filho, \n\ttr2.nome_tipo_resultado as nome_tipo_resultado_pai, \n\tgroup_concat(nome_token order by ordem separator ' ') as phrase\nFROM \n\ttokens t2, \n\tfrases f2, \n\ttipos_resultados tr1, \n\ttipos_resultados tr2, \n\ttipos_acoes\nWHERE \n\tf2.id_token = t2.id_chave_token AND \n\tf2.id_tipo_acao = id_chave_tipo_acao AND \n\ttr1.id_chave_tipo_resultado = id_tipo_resultado AND \n\ttr1.id_tipo_resultado_pai = tr2.id_chave_tipo_resultado\nGROUP BY \n\tf2.id_tipo_acao\n                        \nHAVING \n\tphrase LIKE '' \nORDER BY \n\tid_tipo_resultado, phrase\n, referer: http://localhost/tjd3s-app_fork_20250513/


Quando seleciona um token nas perguntas, obtenho:

[Tue May 13 21:47:23.256431 2025] [php:notice] [pid 4988] [client 127.0.0.1:47680] Executed SQL Query 1:\n\n    SELECT DISTINCT t.nome_token \n    FROM frases f\n    JOIN tokens t ON t.id_chave_token = f.id_token \n    WHERE f.ordem = 1 \n      AND t.nome_token REGEXP '(^|[[:space:]])'\n\n, referer: http://localhost/tjd3s-app_fork_20250513/


VPM 20250513

Identifiquei acionamento de autocomplete em alguns inputs... esse tipo de situação pode forçar a liberação do enabled do próximo input porque a pessoa clica fora do input, gerando um blur... e quando dá blur, aciona o enabled do próximo input (ver handleFormOrder)

VPM 20250513

Um repositório remoto foi criado para colocar a versão com as correções, sem perder o trabalho anteriormente feito. Passou a chamar tjd3s-app_fork_20250513.

VPM 20250513

Com delete_duplicados_frases_e_depois_tipos_acoes.sql foi possível corrigir todas as tipos_acoes duplicadas. 

Esse fenômeno de duplicação dos tipos ações ocorreu porque o GPT, na geração das frases representativas de atividades de EcoSol, acabou mudando os nome_tipo_resultados inadvertidamente e o inserts_resultados.py não conseguia fazer o match pelo nome_tipo_resultado, deixando muitas tipos_acoes orfãs. Ver discussão abaixo. 


VPM 20250513

Colocado o preenchimento automático da data para evitar essa barreira para o usuário (da forma anterior o fluxo de enabled dos inputs esperava o preenchimento da hora, e isso não era intuitivo). Eu preenchi automaticamente com a data e hora atuais, colocando um botão de confirma, para o usuário ter a opção de mudar caso queira fazer uma outra data, ou outra hora.

VPM 20250513

Arquivos para teste dos dados:

select_coringa_para_frases.sql : arquivo padrão para mostrar todas as frases
select_frases_repetidas.sql: arquivo para mostrar as frases repetidas
select_tipos_acoes_para_apagar.sql: arquivo para mostrar as frases que devem ser apagadas
delete_duplicados_frases_e_depois_tipos_acoes.sql: arquivo para deletar frases repetidas (tem que testar mais)


VPM 20250513

Foi atribuída a data e hora no carregamento do aplicativo... para reduzir a sobrecarga do usuário e evitar uma barreira que estava acontecendo: a atribuição de hora era necessária para liberar a busca por frases.

VPM 20250512

Encontrei bug para "promovi evento colaborativo para grupo popular". Não mostra a classificação em amarelo.
O problema é que o tipo_resultado não pode ter símbolos como -, /, ou outra coisa qualquer.

O problema é que o GPT colocou alguns espacinhos e fez algumas abreviações. 

Eu fiz as correções no arquivo troca_feminino_por_masculino.bash

Para verificar se algum tipo_resultado ficou sem frases, pode usar o query:

SELECT 1
select nome_tipo_resultado from tipos_resultados where nome_tipo_resultado not in (select distinct group_concat(distinct nome_tipo_resultado) from tokens join frases on id_token = id_chave_token join tipos_acoes on id_tipo_acao = id_chave_tipo_acao join tipos_resultados on id_tipo_resultado = id_chave_tipo_resultado  group by id_tipo_acao);

O select abaixo identifica os tipos_acoes que não conseguiram (não deram match a partir do que consta no CSV) com um tipo_resultado.

SELECT 2
select group_concat(nome_token order by ordem separator " ") frase from tokens join frases on id_token = id_chave_token join tipos_acoes on id_tipo_acao = id_chave_tipo_acao left join tipos_resultados on id_tipo_resultado = id_chave_tipo_resultado where id_tipo_resultado is null  group by id_tipo_acao;

O SELECT 1 deve mostrar todos os elementos da raiz de tipos_resultados porque não há tipo_acao diretamente ligada ao primeiro nível da árvore tipos_resultados, mas não deve mostrar do nível inferior. Se mostrar, é porque tem algum tipo_acao que não conseguiu achar o tipo_resultado ao que está ligado.

O SELECT 2 mostra todos os tipos_acoes que tem id_tuipo_resultado is null. Curiosamente, o SELECT 1 pode dar os tipos_resultados esperados da raiz da árvore (a menos de dois tipos_resultados que não tem nada a ver, pois eu tinha usado essa tabela erroneamente para guardar as perguntas). Mesmo assim, SELECT 2 pode mostrar várias tipos_acoes que têm id_tipo_resultado nulo.

Se SELECT 1 mostrar nome_tipo_resultado do segundo nível da árvore, ou se SELECT 2 mostrar linhas, então há problemas com o match do nome_tipo_resultado constante no CSV com o nome_tipo_resultado constante no inserts_resultados.py.

VPM 20250512

Big em Z index do sistema de zoom do mapa

VPM 20250512

Encontrei um comportamento ruim na data. O usuário tem que escolher a data através do calendário. Ao selecionar a data, ele tem que digitar a hora... penso que seria melhor a data e hora já estarem preenchidas com o valor atual... ter um botão de confirma... permitindo também a alteração. 

VPM 20250512

Depois de algum tempo, retomo o presente código. Eu já tinha tido que intervir no código por diversas vezes, como na implementação de sugere_codigo2.php ou fetch_frases.php. Identifico que houve avanços em questões como controle de páginas de autenticação por parte dos Bolsistas (page-auth.php, login.php, login.js), mas identifiquei muitos problemas com paths absolutas e relativas, que tive que tratar com horas de análise.

VPM 20250511

Refiz todas as gerações de frases com LLM, partindo da nova estrutura de resultados estabelecida por Sérgio Godoy, em substituição da Renata. Foi bastante trabalho para gerar cerca de 6000 frases para 39 resultados. Usei o prompt gerado com Fábio Stasiak, modificando-o para a nova realidade das definições de resultados do Sérgio. 

Foram horas de e mais horas de geração.

Depois foi preciso adaptar gera_base_completa.bash,  e todos os demais arquivos derivados, para a nova realidade de frases. 
